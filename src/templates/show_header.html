<link rel="stylesheet" type="text/css" href="{{css_path}}jquery.countdown.css">

<script src="{{js_path}}jquery.playSound.js"></script>
<script src="{{js_path}}jquery.plugin.min.js"></script>
<script src="{{js_path}}jquery.countdown.min.js"></script>

<script>
$( document ).ready(function() {
	function is_defined(variable, dflt) {
		return typeof variable === "undefined" ? dflt : variable;
	}
	
	function isEmpty( el ){
      return !$.trim(el.html())
  	}
  	
	function progress(percent, $element, option_width) {
		var p_percent = is_defined(percent, 0);
		var p_option_width = is_defined(option_width, 0);
		$element.width(p_option_width);
		progressBarWidth = p_percent * p_option_width / 100;
		$element.find('div').animate({ width: progressBarWidth }, 500).html(p_percent + "%&nbsp;");
	}
	
	function capitaliseFirstLetter(string) {
		return string.charAt(0).toUpperCase() + string.slice(1);
	}
	
	function get_show_state() {
		$.getJSON("/show_json/", function( voting_data ) {
			 return voting_data
		});
	}
	
	function add_options(element_id, option_data) {
		var all_progress_bars = $(element_id).find('div.progress-bar');
		// If the options haven't been created, create and display them
		if ( $(all_progress_bars).size() == 0 ) {
			for (var option_num in option_data) {
				var cur_num = parseInt(option_num) + 1;
				var option_dict = option_data[option_num];
				var option_row = $('<div class="row"></div>');
				var option_column = $('<div class="col-sm-12"></div>');
				// Create the button with the option name on it
				var option_btn = $('<button class="btn btn-primary btn-block vote-option-font word-wrap">' + cur_num + '. ' + option_dict['name'] + '</button>');
				option_btn.appendTo($(option_column));
				// Create the progress bar html
				var option_percent = $('<div class="progress-bar" style="width: 0;"><div></div></div>');
				// Attach a progress bar below the option button
				progress(option_dict['percent'], $(option_percent), $(option_btn).width());
				$(option_column).append($(option_percent));
				// Attach the row to the given element, and the column to the row
				$(element_id).append($(option_row));
				$(option_row).append($(option_column));
			}
		}
		// Otherwise, updated the options with their current progress
		else {
			// Loop through all the progress bars
			$(all_progress_bars).each(function(index) {
				// Update the progress bars in order of how the options are listed
				progress(option_data[index]['percent'], $(this), $(this).prev().width());
			});
		}
	}
	
	function create_voted_option(element_id, voted_dict) {
		var option_row = $('<div class="row"></div>');
		var option_column = $('<div class="col-sm-12"></div>');
		// Create the button with the option name on it
		var option_btn = $('<button class="btn btn-primary btn-block word-wrap x-large-font">' + voted_dict['voted'] + '</button>');
		option_btn.appendTo($(option_column));
		// Create the progress bar html
		var option_percent = $('<div class="progress-bar" style="width: 0;"><div></div></div>');
		$(option_column).append($(option_percent));
		// Attach the row to the given element, and the column to the row
		$(element_id).append($(option_row));
		$(option_row).append($(option_column));
		// Attach a progress bar below the option button
		progress(voted_dict['percent'], $(option_percent), $(option_percent).prev().width());
	}
	
	function create_vote_panel(element_id, voting_data, update_percent_only) {
		var state = voting_data['state'];
		update_percent_only = typeof update_percent_only !== 'undefined' ? update_percent_only : false;
		// Create the entire panel
		if (update_percent_only === false) {
			var row = $('<div class="row"></div>');
			var column = $('<div class="col-sm-6 col-sm-offset-2"></div>');
			var panel_body = $('<div class="panel-body"></div>');
			var panel_body_row = $('<div class="row"></div>');
			var panel_footer = $('<div class="panel-footer" style="background-color:black;"></div>');
			var countdown_column = $('<div class="col-sm-2 col-sm-offset-5"></div>');
			var countdown_timer = $('<span class="countdown glowingLayout"></span>');
			// Set up the vote start time
			var vote_end = new Date('{{now_tz|date:"F j, Y H:i:s"}}');
			vote_end.setHours(voting_data['hour'], voting_data['minute'], voting_data['second']);
			// Set up the countdown clock
			$(countdown_timer).countdown({until: vote_end, compact: true,
				layout: '<span class="image{s10}"></span><span class="image{s1}"></span>'});
			if (state == 'interval') {
				var panel = $('<div class="panel panel-danger"></div>');
				var panel_header = $('<div class="panel-heading text-center x-large-font">Action Vote</div>');
				var thumbnail_column = $('<div class="col-sm-4 col-sm-offset-4"></div>');
				var thumbnail_img = $('<img src="{{player_image_path}}' + voting_data['player_photo'] + '" class="img-responsive img-thumbnail" />');
				// Add the thumbnail row to the panel body
				$(panel_body).append($(panel_body_row));
				// Add the thumbnail column to the panel body row
				$(panel_body_row).append($(thumbnail_column));
				// Add the player thumbnail image to the thumbnail row
				$(thumbnail_column).append($(thumbnail_img));
			}
			// Change the panel to the appropriate color/heading
			if (state == 'item') {
				var panel = $('<div class="panel panel-success"></div>');
				var panel_header = $('<div class="panel-heading text-center">Item Vote</div>');
			}
			if (state == 'incident') {
				var panel = $('<div class="panel panel-danger"></div>');
				var panel_header = $('<div class="panel-heading text-center">Incident Vote</div>');
			}
			if (state == 'wildcard') {
				var panel = $('<div class="panel panel-info"></div>');
				var panel_header = $('<div class="panel-heading text-center">Character Vote</div>');
			}
			// Add the row to the element
			$(element_id).append($(row));
			// Add the column to the row
			$(row).append($(column));
			// Add the panel to the column
			$(column).append($(panel));
			// Add the panel header to the panel
			$(panel).append($(panel_header));
			// Add the panel body to the panel
			$(panel).append($(panel_body));
			// Add the panel footer to the panel
			$(panel).append($(panel_footer));
		}
		// Just fetch the footer of the pre-created panel
		else {
			var panel_footer = $(element_id).find("div.panel-footer");
		}
		
		// If we're currently in the voting state
		if (voting_data['display'] == 'voting') {
			// Add the countdown timer to the countdown column
			$(countdown_column).append($(countdown_timer));
			// Add the timer to the panel body
			$(panel_body_row).append($(countdown_column));
			add_options(panel_footer, voting_data['options']);
		}
		// We're in the voting result state
		else {
			create_voted_option(panel_footer, voting_data);
		}
		
		return panel
	}
	
	function create_role_panels(element_id, voting_data, update_percent_only) {
		var state = voting_data['state'];
		update_percent_only = typeof update_percent_only !== 'undefined' ? update_percent_only : false;
		// Create the entire panel
		if (update_percent_only === false) {
			var capitalized_role = capitaliseFirstLetter(voting_data['role']);
			var panel = $('<div class="panel panel-primary"></div>');
			var panel_header = $('<div class="panel-heading">' + capitalized_role + ' Vote</div>');
		}
		
		// If we're currently in the voting state
		if (voting_data['display'] == 'voting') {
			// Add the countdown timer to the countdown column
			$(countdown_column).append($(countdown_timer));
			// Add the timer to the panel body
			$(panel_body_row).append($(countdown_column));
		}
		// We're in the voting result state
		else {
			create_voted_role(element_id, voting_data);
		}
	}
	
	function create_voted_role(element_id, voted_dict) {
		var capitalized_role = capitaliseFirstLetter(voted_dict['voted']);
		var row = $('<div class="row"></div>');
		var column = $('<div class="col-sm-6 col-sm-offset-2"></div>');
		var panel = $('<div class="panel panel-primary"></div>');
		var panel_body = $('<div class="panel-body"></div>');
		var panel_body_row = $('<div class="row"></div>');
		var thumbnail_column = $('<div class="col-sm-6 col-sm-offset-3"></div>');
		var thumbnail_img = $('<img src="{{player_image_path}}' + voted_dict['photo_filename'] + '" class="img-responsive img-thumbnail" />');
		var panel_footer = $('<div class="panel-footer" style="background-color:black;"></div>');
		var role_row = $('<div class="row"></div>');
		var role_column = $('<div class="col-sm-12"></div>');
		// Create the button with the option name on it
		var role_btn = $('<button class="btn btn-primary btn-block word-wrap x-large-font">' + capitalized_role + '</button>');
		role_btn.appendTo($(role_column));
		// Create the progress bar html
		var role_percent = $('<div class="progress-bar" style="width: 0;"><div></div></div>');
		$(role_column).append($(role_percent));
		// Add the row to the element
		$(element_id).append($(row));
		// Add the column to the row
		$(row).append($(column));
		// Add the panel to the column
		$(column).append($(panel));
		// Add the panel body to the panel
		$(panel).append($(panel_body));
		// Add the thumbnail row to the panel body
		$(panel_body).append($(panel_body_row));
		// Add the thumbnail column to the panel body row
		$(panel_body_row).append($(thumbnail_column));
		// Add the player thumbnail image to the thumbnail row
		$(thumbnail_column).append($(thumbnail_img));
		// Add the panel footer to the panel
		$(panel).append($(panel_footer));
		// Attach the row to the panel footer
		$(panel_footer).append($(role_row));
		// Attach the role column to the role row
		$(role_row).append($(role_column));
		
		// Attach a progress bar below the option button
		progress(voted_dict['percent'], $(role_percent), $(role_percent).prev().width());
	}
	
	// Hide all objects initially
	$( "#init-players" ).hide();
	$( "#player-action" ).hide();
	// Hide the nav bar and vote selection screen
	$("#top-nav-bar").hide();
	$("#vote-selection-screen").hide();
	var current_display = '';
	
	(function show_loop(){
		// Open the setTimeout
		{% if not mocked %}
		   setTimeout(function(){
			   $.ajax({
				   url: '/show_json/{{show.key.id}}/',
				   success: function( response ){
						// do something with the response
						var voting_data = get_show_state();
						
		{% else %}
			var voting_data = {{mock_data|safe}};
		{% endif %}
		
		// If we've changed the display
		if (voting_data['display'] != current_display) {
			if (voting_data['display'] != 'default') {
				// Hide the nav bar and vote selection screen
				$("#top-nav-bar").hide();
				$("#vote-selection-screen").hide();
				// Show the voting screen
				$("#current-vote").show();
				if (voting_data['display'] == 'voting') {
					// play the opening vote sound
					$.playSound('{{host_url}}{{audio_path}}vote-chime');
				}
				if (voting_data['display'] == 'result') {
					// play the result sound
					$.playSound('{{host_url}}{{audio_path}}action-chime');
				}
				if ('role' in voting_data) {
					// Create the role voting screens
					create_role_panels("#current-vote", voting_data);
				}
				else {
					// Create the voting screen
					create_vote_panel("#current-vote", voting_data);
				}
			}
			else {
				// Show the voting screen
				$("#current-vote").hide();
				// Show the nav bar and vote selection screen
				$("#top-nav-bar").hide();
				$("#vote-selection-screen").show();
			}
			
			current_display = voting_data['display'];
		}
		
		if (voting_data['display'] == 'voting') {
			if ('role' in voting_data) {
				// Update the percentages of the role voting screens
				create_role_panels("#current-vote", voting_data, true);
			}
			else {
				// Update the percentages of the other voting screens
				create_vote_panel("#current-vote", voting_data, true);
			}
		}
		
		// Close the setTimeout
		{% if not mocked %}
				   		show_loop(); // recurse
				   }
		   	   });
	   	   }, 1000);
	   	{% else %}
	   		function sleep(millis, callback) {
				setTimeout(function()
						{ callback(); }
				, millis);
			}
			sleep(1000, show_loop);
	   	{% endif %}
	})();
});
</script>