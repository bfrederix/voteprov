{% extends "base.html" %}
{% block add_head %}
	<script src="{{js_path}}jquery.playSound.js"></script>
	<script>
		$( document ).ready(function() {
			// Hide all objects initially
			//$( "#init-players" ).hide();
			$( "#player-death" ).hide();
			$( "#default" ).show();
			{% if show.running %}
				var prev_event = "default"
				doPoll();
			{% endif %}
			// Poll function that checks for a change every 5 seconds using "always"
			// "done" specifies what to do on a successful fetch
			function doPoll(){
				$.get('/show/{{show.key.id}}/show.json')
						.fail(
							function(data) {
								console.log("Fetch failed.")
								console.log(data)
							}
						)
						.done(
							function(data) {
								console.log(data);
								// Something has changed
								if (data.event !== prev_event) {
									console.log("Change");
									// IF a player has died
									if (data.event === "player-death") {
										// Change the img source to the player that died
										var src = {{image_path}} + data.player_photo
										$("#player-death-img").attr("src", src);
									}
									// Hide all divs
									$( "#init-players,#player-death,#default" ).hide();
									// Show just the active event div
									$("#" + data.event).show();
									if (data.event !== "default") {
										// Play bell toll
										$.playSound('{{host_url}}{{audio_path}}bell_toll');
									}
								}
								// Store the previous event
								prev_event = data.event
							}
						)
						.always(
							function() {
							setTimeout(doPoll, 5000);
							}
						);
			}
		});
	</script>
{% endblock %}
{% block content %}
	<div class="container-fluid">
		<div id="init-players">
			<div class="row">
				<div class="col-sm-6 col-sm-offset-2">
					<h1 class="text-center">Tonight's Deaths</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-1 col-sm-offset-1">
					&nbsp;
				</div>
				{% for player in show.players %}
					{% if forloop.counter|divisibleby:"4" %}
					</div>
					<div class="row">
						<div class="col-sm-1 col-sm-offset-1">
							&nbsp;
						</div>
					{% endif %}
					<div class="col-sm-2"> 
						<div class="panel panel-info">
  							<div class="panel-body">
  								<img src="{{player_image_path}}{{player.photo_filename}}" alt="{{player.name}}" class="img-responsive img-thumbnail">
							</div>
  							<div class="panel-footer text-center" style="background-color:black;">{{player.name}}</div>
						</div>
					</div>
				{% endfor %}
			</div>
		</div>
		{% if show.running %}
			
		{% endif %}
		{% if show.is_today and is_admin and not show.running and not show.start_time %}		
			<div class="row">
				<div class="col-md-4 col-md-offset-4 text-center">
					<h1>Improv Death</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 col-md-offset-4">
					<form action="/show/{{show.key.id}}/" method="post">
						<input type="hidden" name="start_show" value="True">
						<input type="submit" class="btn btn-info btn-block" value="Start the Show!">
					</form>
				</div>
			</div>
		{% endif %}
		{% if show.is_today and not is_admin and not show.running %}		
			Show starts: {{show.scheduled}}
		{% endif %}
		{% if show.in_future %}
			<div class="row">
				<div class="col-md-4 col-md-offset-2">
					{{show.start_time|date:"l N jS, Y @ P"}}
				</div>
			</div>
			<div class="row">
				<h1>Players</h1>
				<div class="col-md-4 col-md-offset-2">
					{% for player in show.players %}
						<img src="{{image_path}}{{player.photo_filename}}" alt="{{player.name}}" class="img-thumbnail">
						{{player.name}}
					{% endfor %}
				</div>
			</div>
		{% endif %}
		{% if show.in_past %}
			<div class="row">
				<div class="col-md-4 col-md-offset-2">
					{{show.start_time|date:"l N jS, Y @ P"}}
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 col-md-offset-2">
					<h1>Deaths</h1>
					{% for death in show.deaths %}
						{{death.time_of_death}}: {{death.player.name}}<br/>
						{{death.cause.cause}}
					{% endfor %}
				</div>
			</div>
		{% endif %}
	</div>
{% endblock %}