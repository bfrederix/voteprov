{% extends "base.html" %}
{% block add_head %}
	<script src="{{js_path}}jquery.playSound.js"></script>
	<script>
		$( document ).ready(function() {
			// Hide all objects initially
			$( "#init-players" ).hide();
			$( "#front-style" ).hide();
			$( "#player-death" ).hide();
			{% if show.running %}
				// Hide Nav Bar
				$( "#top-nav-bar" ).hide();
				run_show();
				function run_show(){
					{% if show.show_style == "front" %}
						$.playSound('{{host_url}}{{audio_path}}bell_toll');
						$( "#front-style" ).show();
					{% endif %}
					{% if show.show_style == "interval" %}
						var current_player = "";
						var hide_players_key = "{% for death in show.deaths %}#player-{{forloop.counter}}{% if not forloop.last %},{% endif %}{% endfor %}"
						var start_time = new Date("{{show.start_time|date:"Y-m-d"}}T{{show.start_time|date:"H:i:s"}}");
						var intervals = {{% for death in show.deaths %}
											{{death.interval}}: "{{forloop.counter}}"{% if not forloop.last %},{% endif %}
										 {% endfor %}};
						// Hide all player divs
						$(hide_players_key).hide();
					
						window.setInterval(function(){
						  change_interval();
						}, 5000);
						function change_interval(){
							var current_time = Date.now();
							var elapsed_millis = current_time - start_time;
							var elapsed_total_seconds = parseInt(elapsed_millis / 1000);
        					var elapsed_minutes = parseInt(elapsed_total_seconds / 60);
							console.log("elapsed minutes: " + elapsed_minutes)
							var interval_keys = $.each(intervals, function(key, value) {return key});
							console.log("interval keys: " + interval_keys)
							if (elapsed_minutes in intervals) {
								if (current_player !== intervals[elapsed_minutes]) {
									current_player = intervals[elapsed_minutes]
									$.playSound('{{host_url}}{{audio_path}}bell_toll');
								}
								$( "#player-death" ).show();
								// Hide all player divs
								$(hide_players_key).hide();
								// Show the current player
								$("#player-" + intervals[elapsed_minutes]).show();
								
							}
						}
					{% endif %}
				}
			{% endif %}
		});
	</script>
{% endblock %}
{% block content %}
	<div class="container-fluid">
		{% if show.running %}
			<div id="default-screen">
				<div class="row">
					<div class="col-sm-6 col-sm-offset-2">
						<h1 class="text-center" style="background-color:#003D7A;">Improv Death<br/> Theme: {{show.theme}}</h1>
					</div>
				</div>
			</div>
			<div id="player-death">
				{% for death in show.deaths %}
					<div id="player-{{forloop.counter}}">
						<div class="row">
							<div class="col-sm-4 col-sm-offset-3">
								<h1 class="text-center" style="background-color:#003D7A;">RIP</h1>
							</div>
						</div>
						<div class="row">	
							<div class="col-sm-4 col-sm-offset-3"> 
								<div class="panel panel-info">
									<div class="panel-body">
										<div class="row text-center">
											<img src="{{player_image_path}}{{death.player.get.photo_filename}}" alt="{{death.player.get.name}}" class="img-responsive img-thumbnail">
										</div>
									</div>
									<div id="player-death-cause" class="panel-footer text-center" style="background-color:black;">{{death.cause.get.cause}}</div>
								</div>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
			<div id="front-style">
				<div class="row">
					<div class="col-sm-1 col-sm-offset-1">
						&nbsp;
					</div>
					{% for death in show.deaths %}
						{% if forloop.counter|divisibleby:"4" %}
						</div>
						<div class="row">
							<div class="col-sm-1 col-sm-offset-1">
								&nbsp;
							</div>
						{% endif %}
						<div class="col-sm-2"> 
							<div class="panel panel-info">
								<div class="panel-body">
									<img src="{{player_image_path}}{{death.player.get.photo_filename}}" alt="{{death.player.get.name}}" class="img-responsive img-thumbnail">
								</div>
								<div class="panel-footer text-center" style="background-color:black;">{{death.cause.get.cause}}</div>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
		{% endif %}
		{% if show.is_today and is_admin and not show.running and not show.start_time %}		
			<div class="row">
				<div class="col-md-4 col-md-offset-4 text-center">
					<h1>Improv Death</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 col-md-offset-4">
					<form action="/show/{{show.key.id}}/" method="post">
						<input type="hidden" name="start_show" value="True">
						{% if available_causes > show.deaths|length %}
							<input type="submit" class="btn btn-info btn-block" style="background-color:#003D7A;" value="Start the Show!">
						{% else %}
							<h1>Need more deaths for show to start!</h1>
						{% endif %}
					</form>
				</div>
			</div>
		{% endif %}
		{% if show.is_today and not is_admin and not show.running %}		
			Show starts: {{show.scheduled}}
		{% endif %}
		{% if show.is_today and is_admin and not show.running and show.start_time %}		
			<h1>Hope you enjoyed the show!</h1>
		{% endif %}
		{% if show.in_future %}
			<div class="row">
				<div class="col-md-4 col-md-offset-2">
					{{show.start_time|date:"l N jS, Y @ P"}}
				</div>
			</div>
			<div class="row">
				<h1>Players</h1>
				<div class="col-md-4 col-md-offset-2">
					{% for player in show.players %}
						<img src="{{image_path}}{{player.photo_filename}}" alt="{{player.name}}" class="img-thumbnail">
						{{player.name}}
					{% endfor %}
				</div>
			</div>
		{% endif %}
		{% if show.in_past %}
			<div class="row">
				<div class="col-md-4 col-md-offset-2">
					{{show.start_time|date:"l N jS, Y @ P"}}
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 col-md-offset-2">
					<h1 class="text-center">Deaths</h1>
					{% for death in show.deaths %}
						{{death.time_of_death}}: {{death.player.name}}<br/>
						{{death.cause.cause}}
					{% endfor %}
				</div>
			</div>
		{% endif %}
	</div>
{% endblock %}