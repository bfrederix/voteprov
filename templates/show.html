{% extends "base.html" %}
{% block add_head %}
	<link rel="stylesheet" type="text/css" href="{{css_path}}jquery.countdown.css">

	<script src="{{js_path}}jquery.playSound.js"></script>
	<script src="{{js_path}}jquery.plugin.min.js"></script>
	<script src="{{js_path}}jquery.countdown.min.js"></script>
	<script>
		$( document ).ready(function() {
			// Hide all objects initially
			$( "#init-players" ).hide();
			$( "#player-action" ).hide();
			// Hide voted action buttons until an action is voted
			var voted_action_list = $(".voted-action-btn");
			for (var i=0; i < voted_action_list.length; i++) {
				$(voted_action_list[i]).hide();
			}
			{% if show.running %}
				// Hide Nav Bar
				$( "#top-nav-bar" ).hide();
				run_show();
				function run_show(){
					var current_player = "";
					var hide_players_key = "{% for player_action in show.player_actions %}#player-{{forloop.counter}}{% if not forloop.last %},{% endif %}{% endfor %}";
					var start_time = new Date('{{show.start_time|date:"F j, Y H:i:s-0700"}}');
					var intervals = {{% for player_action in show.player_actions %}
										{{player_action.interval}}: "{{forloop.counter}}"{% if not forloop.last %},{% endif %}
									 {% endfor %}};
					// Hide all player divs
					$(hide_players_key).hide();
					// Run the interval change immediately
					change_interval();
					window.setInterval(function(){
					  change_interval();
					}, 3000);
					function change_interval(){
						var current_time = new Date();
						var elapsed_millis = current_time - start_time;
						var elapsed_total_seconds = parseInt(elapsed_millis / 1000);
						var elapsed_minutes = parseInt(elapsed_total_seconds / 60);
						console.log(elapsed_minutes);
						// If we've hit an interval
						if (elapsed_minutes in intervals) {
							var hide_vote_buttons = "#po-" + elapsed_minutes + "-1-btn,#po-"  + elapsed_minutes + "-2-btn,#po-" + elapsed_minutes + "-3-btn";
							// If the current player number is different than the interval player number
							if (current_player !== intervals[elapsed_minutes]) {
								// Set the current player number to the interval number
								current_player = intervals[elapsed_minutes];
								$("#player-" + current_player).show();
								$.playSound('{{host_url}}{{audio_path}}vote-chime');
								// Set the vote end sound to false
								var vote_end_played = false;
							}
							// Get the exact minute start of the interval
							var interval_start = new Date(start_time.getTime());
							interval_start.setMinutes(start_time.getMinutes() + elapsed_minutes);
							// Get the ending vote time of the interval
							var vote_end = new Date(interval_start.getTime());
							vote_end.setSeconds(interval_start.getSeconds() + {{VOTE_AFTER_INTERVAL}});
							var interval_url = "/actions_json/{{show.key.id}}/" + elapsed_minutes + "/";
							console.log(interval_url);
							// If we're still in the {{VOTE_AFTER_INTERVAL}} second voting window
							if (current_time <= vote_end) {
								console.log("Voting window!");
								// Hide the final voted action button
								$("va-" + elapsed_minutes + "-btn").hide()
								// Set up the clock
								$('.glowingLayout').countdown({until: vote_end, compact: true, 
    								layout: '<span class="image{s10}"></span><span class="image{s1}"></span>'});
								$(".glowingLayout").show();
								// Pull from the json to get the voting options
								$.get(interval_url, function( data ) {
									console.log("Action fetch!")
									console.log(data);
									// If the user has already voted
									if ("voted" in data) {
										console.log("Voted!");
										// Hide the voting buttons
										$(hide_vote_buttons).hide();
									}
									// Otherwise, set the voting options
									else {
										console.log("Set voting options");
										for (var i=1; i<=3 ;i++) {
											if (i in data) {
												console.log("name: " + data[i]['name']);
												var action_name = data[i]['name'];
												var action_id = data[i]['id'];
												var player_action_prefix = "#po-" + elapsed_minutes + "-" + i;
												$(player_action_prefix + "-act").attr('value', action_id);
												$(player_action_prefix + "-btn").attr('value', action_name);
											}
										}
										// Show the voting buttons
										$(hide_vote_buttons).show();
									}
								});
							}
							// The {{VOTE_AFTER_INTERVAL}} second window has passed
							else {
								console.log('{{VOTE_AFTER_INTERVAL}} seconds are up');
								if ( vote_end_played === false) {
									$.playSound('{{host_url}}{{audio_path}}vote-chime');
									vote_end_played = true;
								}
								$(".glowingLayout").hide();
								$(hide_vote_buttons).hide();
								$.get(interval_url, function( data ) {
									console.log(data['current_action']);
									var voted_action_select = "#va-" + elapsed_minutes + "-btn";
									$(voted_action_select).html(data['current_action']);
									$(voted_action_select).show();
								});
							}
							$( "#player-action" ).show();
							// Hide all player divs
							$(hide_players_key).hide();
							// Show the current player
							$("#player-" + intervals[elapsed_minutes]).show();
						}
					}
				}
			{% endif %}
		});
	</script>
{% endblock %}
{% block content %}
	<div class="container-fluid">
		{% if show.running %}
			<div id="default-screen">
				<div class="row">
					<div class="col-sm-4 col-sm-offset-3">
						<h3 class="text-center" style="background-color:#003D7A;">Choose Your Own Improventure</h3>
					</div>
				</div>
			</div>
			<div id="player-action">
				{% for player_action in show.player_actions %}
					<div id="player-{{forloop.counter}}">
						<div class="row">	
							<div class="col-sm-4 col-sm-offset-3"> 
								<div class="panel panel-info">
									<div class="panel-body">
										<div class="row text-center">
											<img src="{{player_image_path}}{{player_action.player.get.photo_filename}}" alt="{{player_action.player.get.name}}" class="img-responsive img-thumbnail">
										</div>
										<div class="row">
											<div class="col-sm-4 col-sm-offset-4">
												<span class="countdown glowingLayout"></span>
											</div>
										</div>
									</div>
									<div id="player-action-description-{{forloop.counter}}" class="panel-footer text-center" style="background-color:black;">
										<form action="/show/{{show.key.id}}/" method="post">
											<input id="po-{{player_action.interval}}-1-act" type="hidden" name="action_id" value="" />
											<input type="hidden" name="player_id" value="{{player_action.player.key.id}}" />
											<input type="hidden" name="interval" value="{{player_action.interval}}" />
											<input id="po-{{player_action.interval}}-1-btn" type="submit" class="btn btn-info btn-block" value="No other action options"/>
										</form>
										<form action="/show/{{show.key.id}}/" method="post">
											<input id="po-{{player_action.interval}}-2-act" type="hidden" name="action_id" value="" />
											<input type="hidden" name="player_id" value="{{player_action.player.key.id}}" />
											<input type="hidden" name="interval" value="{{player_action.interval}}" />
											<input id="po-{{player_action.interval}}-2-btn" type="submit" class="btn btn-info btn-block" value="No other action options"/>
										</form>
										<form action="/show/{{show.key.id}}/" method="post">
											<input id="po-{{player_action.interval}}-3-act" type="hidden" name="action_id" value="" />
											<input type="hidden" name="player_id" value="{{player_action.player.key.id}}" />
											<input type="hidden" name="interval" value="{{player_action.interval}}" />
											<input id="po-{{player_action.interval}}-3-btn" type="submit" class="btn btn-info btn-block" value="No other action options"/>
										</form>
										<button id="va-{{player_action.interval}}-btn" class="btn btn-default btn-block voted-action-btn"></button>
									</div>
								</div>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
		{% endif %}
		{% if show.is_today and is_admin and not show.running and not show.start_time %}		
			<div class="row">
				<div class="col-md-4 col-md-offset-4 text-center">
					<h1>Choose Your Own Improventure</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 col-md-offset-4">
					<form action="/show/{{show.key.id}}/" method="post">
						<input type="hidden" name="start_show" value="True">
						{% if available_actions >= show.player_actions|length %}
							<input type="submit" class="btn btn-info btn-block" style="background-color:#003D7A;" value="Start the Show!">
						{% else %}
							<h1>Need more actions for show to start!</h1>
						{% endif %}
					</form>
				</div>
			</div>
		{% endif %}
		{% if show.is_today and not is_admin and not show.running %}		
			Show starts: {{show.scheduled}}
		{% endif %}
		{% if show.is_today and is_admin and not show.running and show.start_time %}		
			<h1>Hope you enjoyed the show!</h1>
		{% endif %}
		{% if show.in_future %}
			<div class="row">
				<div class="col-md-6 col-md-offset-2">
					<div class="btn btn-success btn-block btn-lg header-btn">{{show.scheduled|date:"l N jS, Y @ P"}}{% if show.theme %}<br/>Theme: {{show.theme}}{% endif %}</div>
				</div>
			</div>
			<div class="row">
				&nbsp;
			</div>
			<div class="row">
				<div class="col-md-6 col-md-offset-2">
					<div class="btn btn-warning btn-block btn-lg header-btn">Players</div>
				</div>
			</div>
			<div class="row">
				&nbsp;
			</div>
			<div class="row">
				<div class="col-sm-1 col-sm-offset-1">
					&nbsp;
				</div>
				{% for player in show.players %}
					{% if forloop.counter|divisibleby:"4" %}
					</div>
					<div class="row">
						<div class="col-sm-1 col-sm-offset-1">
							&nbsp;
						</div>
					{% endif %}
					<div class="col-sm-2"> 
						<div class="panel panel-info">
							<div class="panel-body">
								<img src="{{player_image_path}}{{player.photo_filename}}" alt="{{player.name}}" class="img-responsive img-thumbnail">
							</div>
							<div class="panel-footer text-center" style="background-color:black;">{{player.name}}</div>
						</div>
					</div>
				{% endfor %}
			</div>
		{% endif %}
		{% if show.in_past %}
			<div class="row">
				<div class="col-md-6 col-md-offset-2">
					<div class="btn btn-info btn-block btn-lg header-btn">{{show.start_time|date:"l N jS, Y @ P"}}<br/>Theme: {{show.theme}}</div>
				</div>
			</div>
			<div class="row">
				&nbsp;
			</div>
			<div class="row">
				<div class="col-md-6 col-md-offset-2">
					<div class="btn btn-danger btn-block btn-lg header-btn">Player Actions</div>
				</div>
			</div>
			<div class="row">
				&nbsp;
			</div>
			<div class="row">
				<div class="col-sm-1 col-sm-offset-1">
					&nbsp;
				</div>
				{% for player_action in show.player_actions %}
					{% if forloop.counter|divisibleby:"4" %}
					</div>
					<div class="row">
						<div class="col-sm-1 col-sm-offset-1">
							&nbsp;
						</div>
					{% endif %}
					<div class="col-sm-2"> 
						<div class="panel panel-info">
							<div class="panel-header text-center name-header">{{player_action.player.get.name}}</div>
							<div class="panel-body">
								<img src="{{player_image_path}}{{player_action.player.get.photo_filename}}" alt="{{player_action.player.get.name}}" class="img-responsive img-thumbnail">
							</div>
							<div class="panel-footer text-center" style="background-color:black;">{{player_action.action.get.description}}</div>
						</div>
					</div>
				{% endfor %}
			</div>
		{% endif %}
	</div>
{% endblock %}